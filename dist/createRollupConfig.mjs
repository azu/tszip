import e from"resolve.exports";import r from"fs-extra/lib/index.js";import o,{extname as s,sep as t,resolve as n}from"path";import a from"camelcase/index.js";import{terser as i}from"rollup-plugin-terser";import{DEFAULT_EXTENSIONS as p}from"@babel/core/lib/index.js";import l from"@rollup/plugin-commonjs/dist/index.js";import c from"@rollup/plugin-json/dist/index.js";import u from"@rollup/plugin-node-resolve";import m from"rollup-plugin-sourcemaps";import f from"typescript/lib/typescript.js";import d from"fs-extra/lib/index.js";import{parse as g}from"@babel/parser/lib/index.js";import h from"@babel/traverse/lib/index.js";import{pascalCase as j}from"pascal-case/dist/index.js";import{createConfigItem as E}from"@babel/core/lib/index.js";import{createBabelInputPluginFactory as b}from"@rollup/plugin-babel/dist/index.js";import x from"lodash.merge";import{optimizeLodashImports as y}from"@optimize-lodash/rollup-plugin/dist/index.js";import{existsSync as v,readFileSync as w}from"fs";const O=e=>a((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")),C=e=>e.toLowerCase().replace(/(^@.*\/)|((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,""),k=r.realpathSync(process.cwd()),M=function(e){return o.resolve(k,e)},F={appPackageJson:M("package.json"),tsconfigJson:M("tsconfig.json"),testsSetup:M("test/setupTests.ts"),appRoot:M("."),appSrc:M("src"),appErrorsJson:M("errors/codes.json"),appErrors:M("errors"),appDist:M("dist"),appConfig:M("export-ts.config.js"),jestConfig:M("jest.config.js"),progressEstimatorCache:M("node_modules/.cache/.progress-estimator")};function J(e){const r={},o=Object.keys(e);for(const s of o)r[e[s]]=s;return r}function P(e){switch(e.type){case"StringLiteral":case"Literal":return e.value;case"BinaryExpression":if("+"!==e.operator)throw new Error("Unsupported binary operator "+e.operator);return P(e.left)+P(e.right);default:throw new Error("Unsupported type "+e.type)}}const S=r.realpathSync(process.cwd()),R=function(e){return o.resolve(S,e)},_={appPackageJson:R("package.json"),tsconfigJson:R("tsconfig.json"),testsSetup:R("test/setupTests.ts"),appRoot:R("."),appSrc:R("src"),appErrorsJson:R("errors/codes.json"),appErrors:R("errors"),appDist:R("dist"),appConfig:R("export-ts.config.js"),jestConfig:R("jest.config.js"),progressEstimatorCache:R("node_modules/.cache/.progress-estimator")},D={sourceType:"module",plugins:["classProperties","flow","jsx","trailingFunctionCommas","objectRestSpread"]};async function $(e){if(!e||!e.errorMapFilePath)throw new Error("Missing options. Ensure you pass an object with `errorMapFilePath`.");if(!e.name||!e.name)throw new Error("Missing options. Ensure you pass --name flag to export-ts");const r=e.errorMapFilePath;let o;try{const e=await d.readFile(r,"utf-8");o=JSON.parse(e)}catch(e){o={}}const s=Object.keys(o);let t;function n(e){const r=g(e,D);h(r,{CallExpression:{exit(e){var r;e.get("callee").isIdentifier({name:"invariant"})&&(r=P(e.node.arguments[1]),o.hasOwnProperty(r)||(o[r]=""+t++))}}})}return t=0===s.length?0:Math.max.apply(null,s)+1,o=J(o),async function(s){n(s),await async function(){const s=j(O(e.name));await d.ensureDir(_.appErrors),await d.writeFile(r,JSON.stringify(J(o),null,2)+"\n","utf-8"),await d.writeFile(_.appErrors+"/ErrorDev.js","\nfunction ErrorDev(message) {\n  const error = new Error(message);\n  error.name = 'Invariant Violation';\n  return error;\n}\n\nexport default ErrorDev;\n      ","utf-8"),await d.writeFile(_.appErrors+"/ErrorProd.js",`\nfunction ErrorProd(code) {\n  // TODO: replace this URL with yours\n  let url = 'https://reactjs.org/docs/error-decoder.html?invariant=' + code;\n  for (let i = 1; i < arguments.length; i++) {\n    url += '&args[]=' + encodeURIComponent(arguments[i]);\n  }\n  return new Error(\n    \`Minified ${s} error #\${code}; visit \${url} for the full message or \` +\n      'use the non-minified dev environment for full errors and additional ' +\n      'helpful warnings. '\n  );\n}\n\nexport default ErrorProd;\n`,"utf-8")}()}}const N=e=>!!e&&(e.constructor!==Object||Object.keys(e).length>0),L=[{original:"lodash(?!/fp)",replacement:"lodash-es"}],q=(e,...r)=>{const o=[];return r.forEach((r=>{r.forEach((r=>{const s=o.findIndex((e=>e.file.resolved===r.file.resolved));-1!==s?o[s]=E([o[s].file.resolved,x(o[s].options,r.options)],{type:e}):o.push(r)}))})),o},z=(e,r)=>r.map((({name:r,...o})=>E([require.resolve(r),o],{type:e}))),I=b((()=>({options:({custom:e,...r})=>({customOptions:e,pluginOptions:r}),config(e,{customOptions:r}){const o=z("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},"cjs"!==r.format&&{name:"babel-plugin-transform-rename-import",replacements:L},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0},N(r.extractErrors)&&{name:"./errors/transformErrorMessages"}].filter(Boolean)),s=e.options||{};s.presets=s.presets||[];const t=s.presets.findIndex((e=>e.file.request.includes("@babel/preset-env")));if(-1!==t){const e=s.presets[t];s.presets[t]=E([e.file.resolved,x({loose:!0,targets:r.targets},e.options,{modules:!1})],{type:"preset"})}else{const e=z("preset",[{name:"@babel/preset-env",targets:r.targets,modules:!1,loose:!0}]);s.presets=q("preset",e,s.presets)}return s.plugins=q("plugin",o,s.plugins||[]),s}})));function A(e){const r=e.split("node_modules"),o=r[0];if(r.length<2)return null;const s=r[1].split(t),a=s[1].startsWith("@")?s.slice(1,3).join(t):s[1];return n(o,"node_modules",a,"package.json")}const B=["react","react-native"],T={errorMapFilePath:F.appErrorsJson};async function U(r,t){const n=await $({...T,...r}),a=r.format.includes("es")||r.format.includes("esm"),d=void 0!==r.minify?r.minify:"production"===r.env||a;let g=["esm","cjs"].includes(r.format)?"":r.format,h="esm"===r.format?"mjs":"cjs";[`${F.appDist}/${C(r.name)}`,g,r.env,d?"min":"",h].filter(Boolean).join(".");const j=f.readConfigFile(r.tsconfig||F.tsconfigJson,f.sys.readFile).config,E=f.parseJsonConfigFileContent(j,f.sys,"./").options,b="production"===process.env.NODE_ENV,x=["esm"===r.format?".mjs":null,"cjs"===r.format?".cjs":null,".js"].filter(Boolean),k=r.input.replace(s(r.input),"");return{input:r.input,external:e=>!e.startsWith("regenerator-runtime")&&(!!B.includes(e)||(e=>!e.startsWith(".")&&!o.isAbsolute(e))(e)),shimMissingExports:!0,treeshake:{propertyReadSideEffects:!1},output:{file:`${k}.${"esm"===r.format?"mjs":"cjs"}`,format:a?"es":r.format,freeze:!1,esModule:Boolean(E?.esModuleInterop)||a,name:r.name||O(r.name),sourcemap:!0,globals:{react:"React","react-native":"ReactNative","lodash-es":"lodashEs","lodash/fp":"lodashFp"},exports:"named"},plugins:[r.extractErrors&&{name:"Extract errors",async transform(e){try{await n(e)}catch(e){return null}return{code:e,map:null}}},u({modulesOnly:!0,browser:"node"!==r.target,extensions:[".jsx",".json",".node"]}),l({extensions:[".js",".cjs",".mjs"],esmExternals:!0,requireReturnsDefault:!0,transformMixedEsModules:!0,include:"umd"===r.format||a?/\/node_modules\//:/\/regenerator-runtime\//}),c(),{name:"Remove shebang",transform:e=>({code:e=e.replace(/^#!(.*)/,""),map:null})},r.legacy&&I({exclude:"node_modules/**",extensions:[...p,"ts","tsx"],passPerPreset:!0,custom:{targets:{..."node"===r.target?{node:14}:{},esmodules:a},extractErrors:r.extractErrors,format:r.format},babelHelpers:"bundled"}),m(),d&&i({format:{keep_quoted_props:!0,comments:!1},compress:{keep_infinity:!0,pure_getters:!0,passes:10},ecma:r.legacy?5:2020,module:a,toplevel:"cjs"===r.format||a}),y({useLodashEs:a||void 0}),r.env&&{name:"Ensure default exports",renderChunk:async(e,r)=>({code:e.replace(/process\.env\.NODE_ENV(?!\s*=)/g,JSON.stringify(b?"production":"development")),map:null})},!r.legacy&&y({useLodashEs:a||void 0}),{name:"Resolve final runtime imports to files",renderChunk:async(o,t)=>{for(const n of t.imports){if(s(n))continue;let t=require.resolve(n);const a=s(t),i=t.replace(a,"");if("esm"===r.format||"cjs"===r.format)for(const e of x){const r=i+e;if(v(r)){t=r;break}}const p=A(t);if(!p||!v(p))continue;const l=w(p,"utf-8"),c=JSON.parse(l);if(e.resolve(c,n))continue;const u=t.slice(t.indexOf(n)),m=new RegExp(`(from|require\\()\\s*['"]${n.replace(".","\\.")}['"]`,"g"),f=o.match(m)??[];for(const e of f){const r=e.replace(n,u);o=o.replace(e,r)}}return{code:o,map:null}}},{name:"Ensure default exports",renderChunk:async(e,r)=>r.exports.includes("default")||!a?null:{code:`${e}\nexport default {};`,map:null}}]}}export{U as createRollupConfig};
export default {};
//# sourceMappingURL=createRollupConfig.mjs.map
