"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("resolve.exports"),r=require("fs-extra/lib/index.js"),s=require("path"),t=require("camelcase/index.js"),o=require("rollup-plugin-terser"),n=require("@babel/core/lib/index.js"),a=require("@rollup/plugin-commonjs/dist/index.js"),i=require("@rollup/plugin-json/dist/index.js"),l=require("@rollup/plugin-node-resolve"),p=require("rollup-plugin-sourcemaps"),u=require("typescript/lib/typescript.js"),c=require("fs-extra/lib/index.js"),f=require("@babel/parser/lib/index.js"),d=require("@babel/traverse/lib/index.js"),m=require("pascal-case/dist/index.js"),g=require("@babel/core/lib/index.js"),h=require("@rollup/plugin-babel/dist/index.js"),j=require("lodash.merge"),E=require("@optimize-lodash/rollup-plugin/dist/index.js"),x=require("fs");function y(e){return e&&"object"==typeof e&&"default"in e?e:{"default":e}}var b=y(e),v=y(r),w=y(s),q=y(t),C=y(a),O=y(i),S=y(l),F=y(p),k=y(u),M=y(c),P=y(d),_=y(j);const I=e=>q.default((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")),J=e=>e.toLowerCase().replace(/(^@.*\/)|((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,""),R=v.default.realpathSync(process.cwd()),D=function(e){return w.default.resolve(R,e)},N={appPackageJson:D("package.json"),tsconfigJson:D("tsconfig.json"),testsSetup:D("test/setupTests.ts"),appRoot:D("."),appSrc:D("src"),appErrorsJson:D("errors/codes.json"),appErrors:D("errors"),appDist:D("dist"),appConfig:D("export-ts.config.js"),jestConfig:D("jest.config.js"),progressEstimatorCache:D("node_modules/.cache/.progress-estimator")};function $(e){const r={},s=Object.keys(e);for(const t of s)r[e[t]]=t;return r}function L(e){switch(e.type){case"StringLiteral":case"Literal":return e.value;case"BinaryExpression":if("+"!==e.operator)throw new Error("Unsupported binary operator "+e.operator);return L(e.left)+L(e.right);default:throw new Error("Unsupported type "+e.type)}}const z=v.default.realpathSync(process.cwd()),A=function(e){return w.default.resolve(z,e)},B={appPackageJson:A("package.json"),tsconfigJson:A("tsconfig.json"),testsSetup:A("test/setupTests.ts"),appRoot:A("."),appSrc:A("src"),appErrorsJson:A("errors/codes.json"),appErrors:A("errors"),appDist:A("dist"),appConfig:A("export-ts.config.js"),jestConfig:A("jest.config.js"),progressEstimatorCache:A("node_modules/.cache/.progress-estimator")},T={sourceType:"module",plugins:["classProperties","flow","jsx","trailingFunctionCommas","objectRestSpread"]};async function U(e){if(!e||!e.errorMapFilePath)throw new Error("Missing options. Ensure you pass an object with `errorMapFilePath`.");if(!e.name||!e.name)throw new Error("Missing options. Ensure you pass --name flag to export-ts");const r=e.errorMapFilePath;let s;try{const e=await M.default.readFile(r,"utf-8");s=JSON.parse(e)}catch(e){s={}}const t=Object.keys(s);let o;function n(e){const r=f.parse(e,T);P.default(r,{CallExpression:{exit(e){var r;e.get("callee").isIdentifier({name:"invariant"})&&(r=L(e.node.arguments[1]),s.hasOwnProperty(r)||(s[r]=""+o++))}}})}return o=0===t.length?0:Math.max.apply(null,t)+1,s=$(s),async function(t){n(t),await async function(){const t=m.pascalCase(I(e.name));await M.default.ensureDir(B.appErrors),await M.default.writeFile(r,JSON.stringify($(s),null,2)+"\n","utf-8"),await M.default.writeFile(B.appErrors+"/ErrorDev.js","\nfunction ErrorDev(message) {\n  const error = new Error(message);\n  error.name = 'Invariant Violation';\n  return error;\n}\n\nexport default ErrorDev;\n      ","utf-8"),await M.default.writeFile(B.appErrors+"/ErrorProd.js",`\nfunction ErrorProd(code) {\n  // TODO: replace this URL with yours\n  let url = 'https://reactjs.org/docs/error-decoder.html?invariant=' + code;\n  for (let i = 1; i < arguments.length; i++) {\n    url += '&args[]=' + encodeURIComponent(arguments[i]);\n  }\n  return new Error(\n    \`Minified ${t} error #\${code}; visit \${url} for the full message or \` +\n      'use the non-minified dev environment for full errors and additional ' +\n      'helpful warnings. '\n  );\n}\n\nexport default ErrorProd;\n`,"utf-8")}()}}const Z=e=>!!e&&(e.constructor!==Object||Object.keys(e).length>0),V=[{original:"lodash(?!/fp)",replacement:"lodash-es"}],W=(e,...r)=>{const s=[];return r.forEach((r=>{r.forEach((r=>{const t=s.findIndex((e=>e.file.resolved===r.file.resolved));-1!==t?s[t]=g.createConfigItem([s[t].file.resolved,_.default(s[t].options,r.options)],{type:e}):s.push(r)}))})),s},H=(e,r)=>r.map((({name:r,...s})=>g.createConfigItem([require.resolve(r),s],{type:e}))),X=h.createBabelInputPluginFactory((()=>({options:({custom:e,...r})=>({customOptions:e,pluginOptions:r}),config(e,{customOptions:r}){const s=H("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},"cjs"!==r.format&&{name:"babel-plugin-transform-rename-import",replacements:V},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0},Z(r.extractErrors)&&{name:"./errors/transformErrorMessages"}].filter(Boolean)),t=e.options||{};t.presets=t.presets||[];const o=t.presets.findIndex((e=>e.file.request.includes("@babel/preset-env")));if(-1!==o){const e=t.presets[o];t.presets[o]=g.createConfigItem([e.file.resolved,_.default({loose:!0,targets:r.targets},e.options,{modules:!1})],{type:"preset"})}else{const e=H("preset",[{name:"@babel/preset-env",targets:r.targets,modules:!1,loose:!0}]);t.presets=W("preset",e,t.presets)}return t.plugins=W("plugin",s,t.plugins||[]),t}})));function G(e){const r=e.split("node_modules"),t=r[0];if(r.length<2)return null;const o=r[1].split(s.sep),n=o[1].startsWith("@")?o.slice(1,3).join(s.sep):o[1];return s.resolve(t,"node_modules",n,"package.json")}const K=["react","react-native"],Q={errorMapFilePath:N.appErrorsJson};exports.createRollupConfig=async function(e,r){const t=await U({...Q,...e}),a=e.format.includes("es")||e.format.includes("esm"),i=void 0!==e.minify?e.minify:"production"===e.env||a;let l=["esm","cjs"].includes(e.format)?"":e.format,p="esm"===e.format?"mjs":"cjs";[`${N.appDist}/${J(e.name)}`,l,e.env,i?"min":"",p].filter(Boolean).join(".");const u=k.default.readConfigFile(e.tsconfig||N.tsconfigJson,k.default.sys.readFile).config,c=k.default.parseJsonConfigFileContent(u,k.default.sys,"./").options,f="production"==="development",d=["esm"===e.format?".mjs":null,"cjs"===e.format?".cjs":null,".js"].filter(Boolean),m=e.input.replace(s.extname(e.input),"");return{input:e.input,external:e=>!e.startsWith("regenerator-runtime")&&(!!K.includes(e)||(e=>!e.startsWith(".")&&!w.default.isAbsolute(e))(e)),shimMissingExports:!0,treeshake:{propertyReadSideEffects:!1},output:{file:`${m}.${"esm"===e.format?"mjs":"cjs"}`,format:a?"es":e.format,freeze:!1,esModule:Boolean(c?.esModuleInterop)||a,name:e.name||I(e.name),sourcemap:!0,globals:{react:"React","react-native":"ReactNative","lodash-es":"lodashEs","lodash/fp":"lodashFp"},exports:"named"},plugins:[e.extractErrors&&{name:"Extract errors",async transform(e){try{await t(e)}catch(e){return null}return{code:e,map:null}}},S.default({modulesOnly:!0,browser:"node"!==e.target,extensions:[".jsx",".json",".node"]}),C.default({extensions:[".js",".cjs",".mjs"],esmExternals:!0,requireReturnsDefault:!0,transformMixedEsModules:!0,include:"umd"===e.format||a?/\/node_modules\//:/\/regenerator-runtime\//}),O.default(),{name:"Remove shebang",transform:e=>({code:e=e.replace(/^#!(.*)/,""),map:null})},e.legacy&&X({exclude:"node_modules/**",extensions:[...n.DEFAULT_EXTENSIONS,"ts","tsx"],passPerPreset:!0,custom:{targets:{..."node"===e.target?{node:14}:{},esmodules:a},extractErrors:e.extractErrors,format:e.format},babelHelpers:"bundled"}),F.default(),i&&o.terser({format:{keep_quoted_props:!0,comments:!1},compress:{keep_infinity:!0,pure_getters:!0,passes:10},ecma:e.legacy?5:2020,module:a,toplevel:"cjs"===e.format||a}),E.optimizeLodashImports({useLodashEs:a||void 0}),e.env&&{name:"Ensure default exports",renderChunk:async(e,r)=>({code:e.replace(/process\.env\.NODE_ENV(?!\s*=)/g,JSON.stringify(f?"production":"development")),map:null})},!e.legacy&&E.optimizeLodashImports({useLodashEs:a||void 0}),{name:"Resolve final runtime imports to files",renderChunk:async(r,t)=>{for(const o of t.imports){if(s.extname(o))continue;let t=require.resolve(o);const n=s.extname(t),a=t.replace(n,"");if("esm"===e.format||"cjs"===e.format)for(const e of d){const r=a+e;if(x.existsSync(r)){t=r;break}}const i=G(t);if(!i||!x.existsSync(i))continue;const l=x.readFileSync(i,"utf-8"),p=JSON.parse(l);if(b.default.resolve(p,o))continue;const u=t.slice(t.indexOf(o)),c=new RegExp(`(from|require\\()\\s*['"]${o.replace(".","\\.")}['"]`,"g"),f=r.match(c)??[];for(const e of f){const s=e.replace(o,u);r=r.replace(e,s)}}return{code:r,map:null}}},{name:"Ensure default exports",renderChunk:async(e,r)=>r.exports.includes("default")||!a?null:{code:`${e}\nexport default {};`,map:null}}]}};
//# sourceMappingURL=createRollupConfig.cjs.map
