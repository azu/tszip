"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("jpjs/dist/jpjs.js"),r=require("fs-extra/lib/index.js"),t=require("path"),s=require("camelcase/index.js"),o=require("resolve.exports"),n=require("rollup-plugin-terser"),a=require("@babel/core/lib/index.js"),i=require("@rollup/plugin-commonjs/dist/index.js"),l=require("@rollup/plugin-json/dist/index.js"),p=require("@rollup/plugin-node-resolve"),u=require("rollup-plugin-sourcemaps"),c=require("typescript/lib/typescript.js"),f=require("@babel/parser/lib/index.js"),d=require("@babel/traverse/lib/index.js"),m=require("pascal-case/dist/index.js"),g=require("@babel/core/lib/index.js"),j=require("@rollup/plugin-babel/dist/index.js"),h=require("lodash.merge"),y=require("@optimize-lodash/rollup-plugin/dist/index.js"),v=require("fs"),E=require("tiny-glob/index.js");function x(e){return e&&"object"==typeof e&&"default"in e?e:{"default":e}}var b=x(r),w=x(t),q=x(s),C=x(o),S=x(i),O=x(l),k=x(p),P=x(u),F=x(c),J=x(d),M=x(h),_=x(E);const D=e=>q.default((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")),I=e=>e.toLowerCase().replace(/(^@.*\/)|((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,""),R=b.default.realpathSync(process.cwd()),$=function(e){return w.default.resolve(R,e)},L={appPackageJson:$("package.json"),tsconfigJson:$("tsconfig.json"),testsSetup:$("test/setupTests.ts"),appRoot:$("."),appSrc:$("src"),appErrorsJson:$("errors/codes.json"),appErrors:$("errors"),appDist:$("dist"),appConfig:$("export-ts.config.js"),jestConfig:$("jest.config.js"),progressEstimatorCache:$("node_modules/.cache/.progress-estimator")},N=b.default.realpathSync(process.cwd()),z=function(e){return w.default.resolve(N,e)},A={appPackageJson:z("package.json"),tsconfigJson:z("tsconfig.json"),testsSetup:z("test/setupTests.ts"),appRoot:z("."),appSrc:z("src"),appErrorsJson:z("errors/codes.json"),appErrors:z("errors"),appDist:z("dist"),appConfig:z("export-ts.config.js"),jestConfig:z("jest.config.js"),progressEstimatorCache:z("node_modules/.cache/.progress-estimator")};function B(e){const r={},t=Object.keys(e);for(const s of t)r[e[s]]=s;return r}function T(e){switch(e.type){case"StringLiteral":case"Literal":return e.value;case"BinaryExpression":if("+"!==e.operator)throw new Error("Unsupported binary operator "+e.operator);return T(e.left)+T(e.right);default:throw new Error("Unsupported type "+e.type)}}const Z=b.default.realpathSync(process.cwd()),U=function(e){return w.default.resolve(Z,e)},V={appPackageJson:U("package.json"),tsconfigJson:U("tsconfig.json"),testsSetup:U("test/setupTests.ts"),appRoot:U("."),appSrc:U("src"),appErrorsJson:U("errors/codes.json"),appErrors:U("errors"),appDist:U("dist"),appConfig:U("export-ts.config.js"),jestConfig:U("jest.config.js"),progressEstimatorCache:U("node_modules/.cache/.progress-estimator")},W={sourceType:"module",plugins:["classProperties","flow","jsx","trailingFunctionCommas","objectRestSpread"]};async function H(e){if(!e||!e.errorMapFilePath)throw new Error("Missing options. Ensure you pass an object with `errorMapFilePath`.");if(!e.name||!e.name)throw new Error("Missing options. Ensure you pass --name flag to export-ts");const r=e.errorMapFilePath;let t;try{const e=await b.default.readFile(r,"utf-8");t=JSON.parse(e)}catch(e){t={}}const s=Object.keys(t);let o;function n(e){const r=f.parse(e,W);J.default(r,{CallExpression:{exit(e){var r;e.get("callee").isIdentifier({name:"invariant"})&&(r=T(e.node.arguments[1]),t.hasOwnProperty(r)||(t[r]=""+o++))}}})}return o=0===s.length?0:Math.max.apply(null,s)+1,t=B(t),async function(s){n(s),await async function(){const s=m.pascalCase((e=>q.default((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")))(e.name));await b.default.ensureDir(V.appErrors),await b.default.writeFile(r,JSON.stringify(B(t),null,2)+"\n","utf-8"),await b.default.writeFile(V.appErrors+"/ErrorDev.js","\nfunction ErrorDev(message) {\n  const error = new Error(message);\n  error.name = 'Invariant Violation';\n  return error;\n}\n\nexport default ErrorDev;\n      ","utf-8"),await b.default.writeFile(V.appErrors+"/ErrorProd.js",`\nfunction ErrorProd(code) {\n  // TODO: replace this URL with yours\n  let url = 'https://reactjs.org/docs/error-decoder.html?invariant=' + code;\n  for (let i = 1; i < arguments.length; i++) {\n    url += '&args[]=' + encodeURIComponent(arguments[i]);\n  }\n  return new Error(\n    \`Minified ${s} error #\${code}; visit \${url} for the full message or \` +\n      'use the non-minified dev environment for full errors and additional ' +\n      'helpful warnings. '\n  );\n}\n\nexport default ErrorProd;\n`,"utf-8")}()}}const X=e=>!!e&&(e.constructor!==Object||Object.keys(e).length>0),G=[{original:"lodash(?!/fp)",replacement:"lodash-es"}],K=(e,...r)=>{const t=[];return r.forEach((r=>{r.forEach((r=>{const s=t.findIndex((e=>e.file.resolved===r.file.resolved));-1!==s?t[s]=g.createConfigItem([t[s].file.resolved,M.default(t[s].options,r.options)],{type:e}):t.push(r)}))})),t},Q=(e,r)=>r.map((({name:r,...t})=>g.createConfigItem([require.resolve(r),t],{type:e}))),Y=j.createBabelInputPluginFactory((()=>({options:({custom:e,...r})=>({customOptions:e,pluginOptions:r}),config(e,{customOptions:r}){const t=Q("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},"cjs"!==r.format&&{name:"babel-plugin-transform-rename-import",replacements:G},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0},X(r.extractErrors)&&{name:"./errors/transformErrorMessages"}].filter(Boolean)),s=e.options||{};s.presets=s.presets||[];const o=s.presets.findIndex((e=>e.file.request.includes("@babel/preset-env")));if(-1!==o){const e=s.presets[o];s.presets[o]=g.createConfigItem([e.file.resolved,M.default({loose:!0,targets:r.targets},e.options,{modules:!1})],{type:"preset"})}else{const e=Q("preset",[{name:"@babel/preset-env",targets:r.targets,modules:!1,loose:!0}]);s.presets=K("preset",e,s.presets)}return s.plugins=K("plugin",t,s.plugins||[]),s}})));function ee(e){const r=e.split("node_modules"),s=r[0];if(r.length<2)return null;const o=r[1].split(t.sep),n=o[1].startsWith("@")?o.slice(1,3).join(t.sep):o[1];return t.resolve(s,"node_modules",n,"package.json")}const re=["react","react-native"],te={errorMapFilePath:A.appErrorsJson};let se={rollup:(e,r)=>e};v.existsSync(L.appConfig)&&(se=require(L.appConfig)),exports.createBuildConfigs=async function(r){const s=await _.default("dist/**/*.js"),o=e.concatAllArray(s.map((e=>function(e,r){return[e.format.includes("cjs")&&{...e,format:"cjs",env:"development",input:r},e.format.includes("cjs")&&{...e,format:"cjs",env:"production",input:r},e.format.includes("esm")&&{...e,format:"esm",input:r},e.format.includes("umd")&&{...e,format:"umd",env:"development",input:r},e.format.includes("umd")&&{...e,format:"umd",env:"production",input:r},e.format.includes("system")&&{...e,format:"system",env:"development",input:r},e.format.includes("system")&&{...e,format:"system",env:"production",input:r}].filter(Boolean)}(r,e).map(((e,r)=>({...e,writeMeta:0===r}))))));return await Promise.all(o.map((async(e,r)=>{const s=await async function(e,r){const s=await H({...te,...e}),o=e.format.includes("es")||e.format.includes("esm"),i=void 0!==e.minify?e.minify:"production"===e.env||o;let l=["esm","cjs"].includes(e.format)?"":e.format,p="esm"===e.format?"mjs":"cjs";[`${A.appDist}/${I(e.name)}`,l,e.env,i?"min":"",p].filter(Boolean).join(".");const u=F.default.readConfigFile(e.tsconfig||A.tsconfigJson,F.default.sys.readFile).config,c=F.default.parseJsonConfigFileContent(u,F.default.sys,"./").options,f="production"==="development",d=["esm"===e.format?".mjs":null,"cjs"===e.format?".cjs":null,".js"].filter(Boolean),m=e.input.replace(t.extname(e.input),"");return{input:e.input,external:e=>!e.startsWith("regenerator-runtime")&&(!!re.includes(e)||(e=>!e.startsWith(".")&&!w.default.isAbsolute(e))(e)),shimMissingExports:!0,treeshake:{propertyReadSideEffects:!1},output:{file:`${m}.${"esm"===e.format?"mjs":"cjs"}`,format:o?"es":e.format,freeze:!1,esModule:Boolean(c?.esModuleInterop)||o,name:e.name||D(e.name),sourcemap:!0,globals:{react:"React","react-native":"ReactNative","lodash-es":"lodashEs","lodash/fp":"lodashFp"},exports:"named"},plugins:[e.extractErrors&&{name:"Extract errors",async transform(e){try{await s(e)}catch(e){return null}return{code:e,map:null}}},k.default({modulesOnly:!0,browser:"node"!==e.target,extensions:[".jsx",".json",".node"]}),S.default({extensions:[".js",".cjs",".mjs"],esmExternals:!0,requireReturnsDefault:!0,transformMixedEsModules:!0,include:"umd"===e.format||o?/\/node_modules\//:/\/regenerator-runtime\//}),O.default(),{name:"Remove shebang",transform:e=>({code:e=e.replace(/^#!(.*)/,""),map:null})},e.legacy&&Y({exclude:"node_modules/**",extensions:[...a.DEFAULT_EXTENSIONS,"ts","tsx"],passPerPreset:!0,custom:{targets:{..."node"===e.target?{node:14}:{},esmodules:o},extractErrors:e.extractErrors,format:e.format},babelHelpers:"bundled"}),P.default(),i&&n.terser({format:{keep_quoted_props:!0,comments:!1},compress:{keep_infinity:!0,pure_getters:!0,passes:10},ecma:e.legacy?5:2020,module:o,toplevel:"cjs"===e.format||o}),y.optimizeLodashImports({useLodashEs:o||void 0}),e.env&&{name:"Ensure default exports",renderChunk:async(e,r)=>({code:e.replace(/process\.env\.NODE_ENV(?!\s*=)/g,JSON.stringify(f?"production":"development")),map:null})},!e.legacy&&y.optimizeLodashImports({useLodashEs:o||void 0}),{name:"Resolve final runtime imports to files",renderChunk:async(r,s)=>{for(const o of s.imports){if(t.extname(o))continue;let s=require.resolve(o);const n=t.extname(s),a=s.replace(n,"");if("esm"===e.format||"cjs"===e.format)for(const e of d){const r=a+e;if(v.existsSync(r)){s=r;break}}const i=ee(s);if(!i||!v.existsSync(i))continue;const l=v.readFileSync(i,"utf-8"),p=JSON.parse(l);if(C.default.resolve(p,o))continue;const u=s.slice(s.indexOf(o)),c=new RegExp(`(from|require\\()\\s*['"]${o.replace(".","\\.")}['"]`,"g"),f=r.match(c)??[];for(const e of f){const t=e.replace(o,u);r=r.replace(e,t)}}return{code:r,map:null}}},{name:"Ensure default exports",renderChunk:async(e,r)=>r.exports.includes("default")||!o?null:{code:`${e}\nexport default {};`,map:null}}]}}(e);return se.rollup(s,e)})))};
//# sourceMappingURL=createBuildConfigs.cjs.map
