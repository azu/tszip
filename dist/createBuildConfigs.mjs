import{concatAllArray as e}from"jpjs/dist/jpjs.js";import r from"fs-extra/lib/index.js";import o,{extname as s,sep as t,resolve as n}from"path";import a from"camelcase/index.js";import i from"resolve.exports";import{terser as p}from"rollup-plugin-terser";import{DEFAULT_EXTENSIONS as l}from"@babel/core/lib/index.js";import c from"@rollup/plugin-commonjs/dist/index.js";import u from"@rollup/plugin-json/dist/index.js";import m from"@rollup/plugin-node-resolve";import f from"rollup-plugin-sourcemaps";import d from"typescript/lib/typescript.js";import{parse as g}from"@babel/parser/lib/index.js";import j from"@babel/traverse/lib/index.js";import{pascalCase as h}from"pascal-case/dist/index.js";import{createConfigItem as v}from"@babel/core/lib/index.js";import{createBabelInputPluginFactory as y}from"@rollup/plugin-babel/dist/index.js";import E from"lodash.merge";import{optimizeLodashImports as b}from"@optimize-lodash/rollup-plugin/dist/index.js";import{existsSync as x,readFileSync as w}from"fs";import C from"tiny-glob/index.js";const O=e=>a((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")),k=e=>e.toLowerCase().replace(/(^@.*\/)|((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,""),J=r.realpathSync(process.cwd()),S=function(e){return o.resolve(J,e)},M={appPackageJson:S("package.json"),tsconfigJson:S("tsconfig.json"),testsSetup:S("test/setupTests.ts"),appRoot:S("."),appSrc:S("src"),appErrorsJson:S("errors/codes.json"),appErrors:S("errors"),appDist:S("dist"),appConfig:S("export-ts.config.js"),jestConfig:S("jest.config.js"),progressEstimatorCache:S("node_modules/.cache/.progress-estimator")},P=r.realpathSync(process.cwd()),F=function(e){return o.resolve(P,e)},R={appPackageJson:F("package.json"),tsconfigJson:F("tsconfig.json"),testsSetup:F("test/setupTests.ts"),appRoot:F("."),appSrc:F("src"),appErrorsJson:F("errors/codes.json"),appErrors:F("errors"),appDist:F("dist"),appConfig:F("export-ts.config.js"),jestConfig:F("jest.config.js"),progressEstimatorCache:F("node_modules/.cache/.progress-estimator")};function _(e){const r={},o=Object.keys(e);for(const s of o)r[e[s]]=s;return r}function D(e){switch(e.type){case"StringLiteral":case"Literal":return e.value;case"BinaryExpression":if("+"!==e.operator)throw new Error("Unsupported binary operator "+e.operator);return D(e.left)+D(e.right);default:throw new Error("Unsupported type "+e.type)}}const $=r.realpathSync(process.cwd()),N=function(e){return o.resolve($,e)},z={appPackageJson:N("package.json"),tsconfigJson:N("tsconfig.json"),testsSetup:N("test/setupTests.ts"),appRoot:N("."),appSrc:N("src"),appErrorsJson:N("errors/codes.json"),appErrors:N("errors"),appDist:N("dist"),appConfig:N("export-ts.config.js"),jestConfig:N("jest.config.js"),progressEstimatorCache:N("node_modules/.cache/.progress-estimator")},L={sourceType:"module",plugins:["classProperties","flow","jsx","trailingFunctionCommas","objectRestSpread"]};async function q(e){if(!e||!e.errorMapFilePath)throw new Error("Missing options. Ensure you pass an object with `errorMapFilePath`.");if(!e.name||!e.name)throw new Error("Missing options. Ensure you pass --name flag to export-ts");const o=e.errorMapFilePath;let s;try{const e=await r.readFile(o,"utf-8");s=JSON.parse(e)}catch(e){s={}}const t=Object.keys(s);let n;function i(e){const r=g(e,L);j(r,{CallExpression:{exit(e){var r;e.get("callee").isIdentifier({name:"invariant"})&&(r=D(e.node.arguments[1]),s.hasOwnProperty(r)||(s[r]=""+n++))}}})}return n=0===t.length?0:Math.max.apply(null,t)+1,s=_(s),async function(t){i(t),await async function(){const t=h((e=>a((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")))(e.name));await r.ensureDir(z.appErrors),await r.writeFile(o,JSON.stringify(_(s),null,2)+"\n","utf-8"),await r.writeFile(z.appErrors+"/ErrorDev.js","\nfunction ErrorDev(message) {\n  const error = new Error(message);\n  error.name = 'Invariant Violation';\n  return error;\n}\n\nexport default ErrorDev;\n      ","utf-8"),await r.writeFile(z.appErrors+"/ErrorProd.js",`\nfunction ErrorProd(code) {\n  // TODO: replace this URL with yours\n  let url = 'https://reactjs.org/docs/error-decoder.html?invariant=' + code;\n  for (let i = 1; i < arguments.length; i++) {\n    url += '&args[]=' + encodeURIComponent(arguments[i]);\n  }\n  return new Error(\n    \`Minified ${t} error #\${code}; visit \${url} for the full message or \` +\n      'use the non-minified dev environment for full errors and additional ' +\n      'helpful warnings. '\n  );\n}\n\nexport default ErrorProd;\n`,"utf-8")}()}}const A=e=>!!e&&(e.constructor!==Object||Object.keys(e).length>0),B=[{original:"lodash(?!/fp)",replacement:"lodash-es"}],I=(e,...r)=>{const o=[];return r.forEach((r=>{r.forEach((r=>{const s=o.findIndex((e=>e.file.resolved===r.file.resolved));-1!==s?o[s]=v([o[s].file.resolved,E(o[s].options,r.options)],{type:e}):o.push(r)}))})),o},Z=(e,r)=>r.map((({name:r,...o})=>v([require.resolve(r),o],{type:e}))),T=y((()=>({options:({custom:e,...r})=>({customOptions:e,pluginOptions:r}),config(e,{customOptions:r}){const o=Z("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},"cjs"!==r.format&&{name:"babel-plugin-transform-rename-import",replacements:B},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0},A(r.extractErrors)&&{name:"./errors/transformErrorMessages"}].filter(Boolean)),s=e.options||{};s.presets=s.presets||[];const t=s.presets.findIndex((e=>e.file.request.includes("@babel/preset-env")));if(-1!==t){const e=s.presets[t];s.presets[t]=v([e.file.resolved,E({loose:!0,targets:r.targets},e.options,{modules:!1})],{type:"preset"})}else{const e=Z("preset",[{name:"@babel/preset-env",targets:r.targets,modules:!1,loose:!0}]);s.presets=I("preset",e,s.presets)}return s.plugins=I("plugin",o,s.plugins||[]),s}})));function U(e){const r=e.split("node_modules"),o=r[0];if(r.length<2)return null;const s=r[1].split(t),a=s[1].startsWith("@")?s.slice(1,3).join(t):s[1];return n(o,"node_modules",a,"package.json")}const V=["react","react-native"],W={errorMapFilePath:R.appErrorsJson};let H={rollup:(e,r)=>e};async function G(r){const t=await C("dist/**/*.js"),n=e(t.map((e=>function(e,r){return[e.format.includes("cjs")&&{...e,format:"cjs",env:"development",input:r},e.format.includes("cjs")&&{...e,format:"cjs",env:"production",input:r},e.format.includes("esm")&&{...e,format:"esm",input:r},e.format.includes("umd")&&{...e,format:"umd",env:"development",input:r},e.format.includes("umd")&&{...e,format:"umd",env:"production",input:r},e.format.includes("system")&&{...e,format:"system",env:"development",input:r},e.format.includes("system")&&{...e,format:"system",env:"production",input:r}].filter(Boolean)}(r,e).map(((e,r)=>({...e,writeMeta:0===r}))))));return await Promise.all(n.map((async(e,r)=>{const t=await async function(e,r){const t=await q({...W,...e}),n=e.format.includes("es")||e.format.includes("esm"),a=void 0!==e.minify?e.minify:"production"===e.env||n;let g=["esm","cjs"].includes(e.format)?"":e.format,j="esm"===e.format?"mjs":"cjs";[`${R.appDist}/${k(e.name)}`,g,e.env,a?"min":"",j].filter(Boolean).join(".");const h=d.readConfigFile(e.tsconfig||R.tsconfigJson,d.sys.readFile).config,v=d.parseJsonConfigFileContent(h,d.sys,"./").options,y="production"===process.env.NODE_ENV,E=["esm"===e.format?".mjs":null,"cjs"===e.format?".cjs":null,".js"].filter(Boolean),C=e.input.replace(s(e.input),"");return{input:e.input,external:e=>!e.startsWith("regenerator-runtime")&&(!!V.includes(e)||(e=>!e.startsWith(".")&&!o.isAbsolute(e))(e)),shimMissingExports:!0,treeshake:{propertyReadSideEffects:!1},output:{file:`${C}.${"esm"===e.format?"mjs":"cjs"}`,format:n?"es":e.format,freeze:!1,esModule:Boolean(v?.esModuleInterop)||n,name:e.name||O(e.name),sourcemap:!0,globals:{react:"React","react-native":"ReactNative","lodash-es":"lodashEs","lodash/fp":"lodashFp"},exports:"named"},plugins:[e.extractErrors&&{name:"Extract errors",async transform(e){try{await t(e)}catch(e){return null}return{code:e,map:null}}},m({modulesOnly:!0,browser:"node"!==e.target,extensions:[".jsx",".json",".node"]}),c({extensions:[".js",".cjs",".mjs"],esmExternals:!0,requireReturnsDefault:!0,transformMixedEsModules:!0,include:"umd"===e.format||n?/\/node_modules\//:/\/regenerator-runtime\//}),u(),{name:"Remove shebang",transform:e=>({code:e=e.replace(/^#!(.*)/,""),map:null})},e.legacy&&T({exclude:"node_modules/**",extensions:[...l,"ts","tsx"],passPerPreset:!0,custom:{targets:{..."node"===e.target?{node:14}:{},esmodules:n},extractErrors:e.extractErrors,format:e.format},babelHelpers:"bundled"}),f(),a&&p({format:{keep_quoted_props:!0,comments:!1},compress:{keep_infinity:!0,pure_getters:!0,passes:10},ecma:e.legacy?5:2020,module:n,toplevel:"cjs"===e.format||n}),b({useLodashEs:n||void 0}),e.env&&{name:"Ensure default exports",renderChunk:async(e,r)=>({code:e.replace(/process\.env\.NODE_ENV(?!\s*=)/g,JSON.stringify(y?"production":"development")),map:null})},!e.legacy&&b({useLodashEs:n||void 0}),{name:"Resolve final runtime imports to files",renderChunk:async(r,o)=>{for(const t of o.imports){if(s(t))continue;let o=require.resolve(t);const n=s(o),a=o.replace(n,"");if("esm"===e.format||"cjs"===e.format)for(const e of E){const r=a+e;if(x(r)){o=r;break}}const p=U(o);if(!p||!x(p))continue;const l=w(p,"utf-8"),c=JSON.parse(l);if(i.resolve(c,t))continue;const u=o.slice(o.indexOf(t)),m=new RegExp(`(from|require\\()\\s*['"]${t.replace(".","\\.")}['"]`,"g"),f=r.match(m)??[];for(const e of f){const o=e.replace(t,u);r=r.replace(e,o)}}return{code:r,map:null}}},{name:"Ensure default exports",renderChunk:async(e,r)=>r.exports.includes("default")||!n?null:{code:`${e}\nexport default {};`,map:null}}]}}(e);return H.rollup(t,e)})))}x(M.appConfig)&&(H=require(M.appConfig));export{G as createBuildConfigs};
export default {};
//# sourceMappingURL=createBuildConfigs.mjs.map
